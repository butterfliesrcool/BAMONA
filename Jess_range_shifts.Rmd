---
title: "Jess_range_shifts"
author: "Jessica Herrmann"
date: "2022-11-03"
output: html_document
---

[1] Load Package Libraries
```{r}
library(curl)
library(ggplot2)
library(MASS)
library(curl)
library(raster)
library(spatialEco)
library(lubridate)
library(rstudioapi)
library(ggmap)
```

Linking in API key
```{r}
register_google(key = "")
```

A function that can be called to load and clean each data set
```{r}
load_data <- function(url){
  
  d <- curl(url)
  d.csv <- read.csv(d, header = TRUE, sep = ",")
  
  d.clean <- na.omit(d.csv)
  d.clean <- subset(d.clean, select = -c(Organism.Type,Location.Notes, Observation.Notes, Updated.Date, Partner.Project, Data.Source, Submitter ) )
  d.clean <- subset(d.clean, Specimen.Type %in% c("Specimen", "Photograph"), drop = FALSE)
  
  return(d.clean)
  
}
```

Loading/cleaning the data for each species
```{r}
bphi <- load_data("https://raw.githubusercontent.com/butterfliesrcool/BAMONA/main/battus_philenor.csv")
last <- load_data("https://raw.githubusercontent.com/butterfliesrcool/BAMONA/main/limenitis_arthemis_astyanax.csv")
ppol <- load_data("https://raw.githubusercontent.com/butterfliesrcool/BAMONA/main/papilio_polyxenes.csv")
ptro <- load_data("https://raw.githubusercontent.com/butterfliesrcool/BAMONA/main/papilio_troilus.csv")
pgla_0 <- load_data("https://raw.githubusercontent.com/butterfliesrcool/BAMONA/main/papilio_glaucus.csv")

# Have to modify it a little for the S. diana data set:
sdia_0 <- curl("https://raw.githubusercontent.com/butterfliesrcool/BAMONA/main/speyeria.diana.csv")
sdia_0 <- read.csv(sdia_0, header = TRUE, sep = ",")
sdia_0 <- na.omit(sdia_0)
sdia_0 <- subset(sdia_0, Specimen.Type %in% c("Specimen", "Photograph"), drop = FALSE)
```

Additional cleaning for P. glaucus and S. diana data
```{r}
## P. glaucus:
pgla <- subset(pgla_0, Sex == "BF", drop = FALSE)
length(pgla$Record.Number)
pgla

## S. diana:
sdia <- subset(sdia_0, sex == "F", drop = FALSE)
length(sdia$Record.Number)
sdia
```

[6] Use the lubridate() package to separate data by yearly increments
```{r}
bphi
bphi.dates <- parse_date_time(bphi$Observation.Date, "mdy")
bphi.years <- year(bphi.dates) # year() fxn creates separate column for years
bphi$years <- bphi.years # adds "years" column back into data set

# orders data set by "years" decreasing (most recent first)
bphi <- bphi[order(bphi$years,decreasing=T),]
bphi

# shows first and last six data points
head(bphi)
tail(bphi)

# increases the max.print so we can see all data (otherwise R cuts it off at the first 1000 data points)
options(max.print=1000000)
bphi$years
```

Finding n for each subset
```{r}
# Subset for 1889 - 1969:

bphi.1889_1969 <- subset(bphi, years %in% c("1889", "1890", "1891", "1892", "1893", "1894", "1895", "1896", "1897", "1898", "1899", "1900", "1901", "1902", "1903", "1904", "1905", "1906", "1907", "1908", "1909", "1910","1911", "1912", "1913", "1914", "1915", "1916", "1917","1918", "1919", "1920", "1921", "1922", "1923", "1924", "1925", "1926", "1927", "1928", "1929", "1930", "1931", "1932", "1933", "1934", "1935", "1936", "1937", "1938", "1939", "1940", "1941", "1942", "1943", "1944", "1945", "1946", "1947", "1948", "1949", "1950", "1951", "1952", "1953", "1954", "1955", "1956", "1957", "1958", "1959", "1960", "1961", "1962", "1963", "1964", "1965", "1966", "1967", "1968", "1969"), drop = FALSE)
length(bphi.1889_1969$Record.Number)
## n = 25



# 1970s - 1990s subset by decade:

bphi.1970_1979 <- subset(bphi, years %in% c("1970","1971", "1972", "1973", "1974", "1975", "1976", "1977", "1978", "1979"), drop = FALSE)
length(bphi.1970_1979$Record.Number)
## n = 7

bphi.1980_1989 <- subset(bphi, years %in% c("1980","1981", "1982", "1933", "1984", "1985", "1986", "1987", "1988", "1989"), drop = FALSE)
length(bphi.1980_1989$Record.Number)
# n = 10

bphi.1990_1999 <- subset(bphi, years %in% c("1990", "1991", "1992", "1993", "1994", "1995", "1996", "1997", "1998", "1999"), drop = FALSE)
length(bphi.1990_1999$Record.Number)
## n = 18



# 1970 - 1999:

bphi.1970_1999 <- subset(bphi, years %in% c("1970","1971", "1972", "1973", "1974", "1975", "1976", "1977", "1978", "1979", "1980","1981", "1982", "1933", "1984", "1985", "1986", "1987", "1988", "1989", "1990", "1991", "1992", "1993", "1994", "1995", "1996", "1997", "1998", "1999"), drop = FALSE)
length(bphi.1970_1999$Record.Number)
## n = 35


# All years 1889 - 1999:

bphi.1889_1999 <- subset(bphi, years %in% c("1889", "1890", "1891", "1892", "1893", "1894", "1895", "1896", "1897", "1898", "1899", "1900", "1901", "1902", "1903", "1904", "1905", "1906", "1907", "1908", "1909", "1910","1911", "1912", "1913", "1914", "1915", "1916", "1917","1918", "1919", "1920", "1921", "1922", "1923", "1924", "1925", "1926", "1927", "1928", "1929", "1930", "1931", "1932", "1933", "1934", "1935", "1936", "1937", "1938", "1939", "1940", "1941", "1942", "1943", "1944", "1945", "1946", "1947", "1948", "1949", "1950", "1951", "1952", "1953", "1954", "1955", "1956", "1957", "1958", "1959", "1960", "1961", "1962", "1963", "1964", "1965", "1966", "1967", "1968", "1969", "1970","1971", "1972", "1973", "1974", "1975", "1976", "1977", "1978", "1979", "1980","1981", "1982", "1933", "1984", "1985", "1986", "1987", "1988", "1989", "1990", "1991", "1992", "1993", "1994", "1995", "1996", "1997", "1998", "1999"), drop = FALSE)
length(bphi.1889_1999$Record.Number)
## n = 58


# 2000 - 2021 subset at two-yr intervals this way...

bphi.2000_2001 <- subset(bphi, years %in% c("2000", "2001"), drop = FALSE)
length(bphi.2000_2001$Record.Number)
## n = 1

bphi.2002_2003 <- subset(bphi, years %in% c("2002", "2003"), drop = FALSE)
length(bphi.2002_2003$Record.Number)
## n = 2

bphi.2004_2005 <- subset(bphi, years %in% c("2004", "2005"), drop = FALSE)
length(bphi.2004_2005$Record.Number)
## n = 7

bphi.2006_2007 <- subset(bphi, years %in% c("2006", "2007"), drop = FALSE)
length(bphi.2006_2007$Record.Number)
## n = 21

bphi.2008_2009 <- subset(bphi, years %in% c("2008", "2009"), drop = FALSE)
length(bphi.2008_2009$Record.Number)
## n = 40

bphi.2010_2011 <- subset(bphi, years %in% c("2010", "2011"), drop = FALSE)
length(bphi.2010_2011$Record.Number)
## n = 102

bphi.2012_2013 <- subset(bphi, years %in% c("2012", "2013"), drop = FALSE)
length(bphi.2012_2013$Record.Number)
## n = 204

bphi.2014_2015 <- subset(bphi, years %in% c("2014", "2015"), drop = FALSE)
length(bphi.2014_2015$Record.Number)
## n = 172

bphi.2016_2017 <- subset(bphi, years %in% c("2016", "2017"), drop = FALSE)
length(bphi.2016_2017$Record.Number)
## n = 252

bphi.2018_2019 <- subset(bphi, years %in% c("2018", "2019"), drop = FALSE)
length(bphi.2018_2019$Record.Number)
## n = 292

bphi.2020_2021 <- subset(bphi, years %in% c("2020", "2021"), drop = FALSE)
length(bphi.2020_2021$Record.Number)
## n = 131

# So far what I'm seeing is that, pre-2010, there was not a lot of data. And the collection times were kind of sporadic (i.e. some years there was no data, then in other years/decades, there was more data collected.) I think it makes sense to look closely at the 2010-2021 time frame for starters.


bphi.2000_2010 <- subset(bphi, years %in% c("2000","2001", "2002", "2003", "2004", "2005", "2006", "2007", "2008", "2009", "2010"), drop = FALSE)
length(bphi.2000_2010$Record.Number)
## n = 122

bphi.2011_2021 <- subset(bphi, years %in% c("2011", "2012", "2013", "2014", "2015", "2016", "2017", "2018", "2019", "2020", "2021"), drop = FALSE)
length(bphi.2011_2021$Record.Number)
## n = 1102
```

Generate a heat map for Battus, 1889 - 1969 data
```{r}
bphi.1889_1969_heatmap <- ggmap(get_googlemap(center = c(lon = -79.74658480805773, lat = 37.20888926712938),
                                  zoom = 4,scale = 2,
                                  maptype = 'terrain',
                                  color = 'color'))+
  stat_density2d(aes(x = Longitude, y = Lat.Long, fill = ..level..),
                 alpha = .2,
                 bins = 15, data = bphi.1889_1969, geom = "polygon") +
  labs(fill="B. philenor Population Density, 1889 - 1969") +
  scale_fill_viridis_c(option = "plasma")

bphi.1889_1969_heatmap
```

Same thing, but for 1970 - 1999 Battus data
```{r}
bphi.1970_1999_heatmap <- ggmap(get_googlemap(center = c(lon = -79.74658480805773, lat = 37.20888926712938),
                                  zoom = 4,scale = 2,
                                  maptype = 'terrain',
                                  color = 'color'))+
  stat_density2d(aes(x = Longitude, y = Lat.Long, fill = ..level..),
                 alpha = .2,
                 bins = 15, data = bphi.1970_1999, geom = "polygon") +
  labs(fill="B. philenor Population Density, 1970 - 1999") +
  scale_fill_viridis_c(option = "plasma")

bphi.1970_1999_heatmap
```
1889 - 1999 Battus data heat map
```{r}
bphi.1889_1999_heatmap <- ggmap(get_googlemap(center = c(lon = -79.74658480805773, lat = 37.20888926712938),
                                  zoom = 4,scale = 2,
                                  maptype = 'terrain',
                                  color = 'color'))+
  stat_density2d(aes(x = Longitude, y = Lat.Long, fill = ..level..),
                 alpha = .2,
                 bins = 15, data = bphi.1889_1999, geom = "polygon") +
  labs(fill="B. philenor Population Density, 1889 - 1999") +
  scale_fill_viridis_c(option = "plasma")

bphi.1889_1999_heatmap
```
2000 - 2009 Battus data heat map
```{r}
bphi.2000_2009_heatmap <- ggmap(get_googlemap(center = c(lon = -79.74658480805773, lat = 37.20888926712938),
                                  zoom = 4,scale = 2,
                                  maptype = 'terrain',
                                  color = 'color'))+
  stat_density2d(aes(x = Longitude, y = Lat.Long, fill = ..level..),
                 alpha = .2,
                 bins = 15, data = bphi.2000_2009, geom = "polygon") +
  labs(fill="B. philenor Population Density, 2000 - 2009") +
  scale_fill_viridis_c(option = "plasma")

bphi.2000_2009_heatmap
```
2010 - 2011 Battus data heat map
```{r}
bphi.2010_2011_heatmap <- ggmap(get_googlemap(center = c(lon = -79.74658480805773, lat = 37.20888926712938),
                                  zoom = 4,scale = 2,
                                  maptype = 'terrain',
                                  color = 'color'))+
  stat_density2d(aes(x = Longitude, y = Lat.Long, fill = ..level..),
                 alpha = .2,
                 bins = 15, data = bphi.2010_2011, geom = "polygon") +
  labs(fill="B. philenor Population Density, 2010 - 2011") +
  scale_fill_viridis_c(option = "plasma")

bphi.2010_2011_heatmap
```

2012 - 2013 Battus data heat map
```{r}
bphi.2012_2013_heatmap <- ggmap(get_googlemap(center = c(lon = -79.74658480805773, lat = 37.20888926712938),
                                  zoom = 4,scale = 2,
                                  maptype = 'terrain',
                                  color = 'color'))+
  stat_density2d(aes(x = Longitude, y = Lat.Long, fill = ..level..),
                 alpha = .2,
                 bins = 15, data = bphi.2012_2013, geom = "polygon") +
  labs(fill="B. philenor Population Density, 2012 - 2013") +
  scale_fill_viridis_c(option = "plasma")

bphi.2012_2013_heatmap
```
2014 - 2015 Battus data heat map
```{r}
bphi.2014_2015_heatmap <- ggmap(get_googlemap(center = c(lon = -79.74658480805773, lat = 37.20888926712938),
                                  zoom = 4,scale = 2,
                                  maptype = 'terrain',
                                  color = 'color'))+
  stat_density2d(aes(x = Longitude, y = Lat.Long, fill = ..level..),
                 alpha = .2,
                 bins = 15, data = bphi.2014_2015, geom = "polygon") +
  labs(fill="B. philenor Population Density, 2014 - 2015") +
  scale_fill_viridis_c(option = "plasma")

bphi.2014_2015_heatmap
```

2016 - 2017 Battus data heat map
```{r}
bphi.2016_2017_heatmap <- ggmap(get_googlemap(center = c(lon = -79.74658480805773, lat = 37.20888926712938),
                                  zoom = 4,scale = 2,
                                  maptype = 'terrain',
                                  color = 'color'))+
  stat_density2d(aes(x = Longitude, y = Lat.Long, fill = ..level..),
                 alpha = .2,
                 bins = 15, data = bphi.2016_2017, geom = "polygon") +
  labs(fill="B. philenor Population Density, 2016 - 2017") +
  scale_fill_viridis_c(option = "plasma")

bphi.2016_2017_heatmap
```

2018 - 2019 Battus data heat map
```{r}
bphi.2018_2019_heatmap <- ggmap(get_googlemap(center = c(lon = -79.74658480805773, lat = 37.20888926712938),
                                  zoom = 4,scale = 2,
                                  maptype = 'terrain',
                                  color = 'color'))+
  stat_density2d(aes(x = Longitude, y = Lat.Long, fill = ..level..),
                 alpha = .2,
                 bins = 15, data = bphi.2018_2019, geom = "polygon") +
  labs(fill="B. philenor Population Density, 2018 - 2019") +
  scale_fill_viridis_c(option = "plasma")

bphi.2018_2019_heatmap
```

2020 - 2021 Battus data heat map
```{r}
bphi.2020_2021_heatmap <- ggmap(get_googlemap(center = c(lon = -79.74658480805773, lat = 37.20888926712938),
                                  zoom = 4,scale = 2,
                                  maptype = 'terrain',
                                  color = 'color'))+
  stat_density2d(aes(x = Longitude, y = Lat.Long, fill = ..level..),
                 alpha = .2,
                 bins = 15, data = bphi.2020_2021, geom = "polygon") +
  labs(fill="B. philenor Population Density, 2020 - 2021") +
  scale_fill_viridis_c(option = "plasma")

bphi.2020_2021_heatmap
```


```{r}
bphi.2000_2021_heatmap <- ggmap(get_googlemap(center = c(lon = -79.74658480805773, lat = 37.20888926712938),
                                  zoom = 4,scale = 2,
                                  maptype = 'terrain',
                                  color = 'color'))+
  stat_density2d(aes(x = Longitude, y = Lat.Long, fill = ..level..),
                 alpha = .2,
                 bins = 15, data = bphi.2000_2021, geom = "polygon") +
  labs(fill="B. philenor Population Density, 2000 - 2021") +
  scale_fill_viridis_c(option = "plasma")

bphi.2000_2021_heatmap
```
*** Dividing the data into three subsets by year: 1869-1999, 2000-2010, and 2011-2021 ***

1889 - 1999 Battus data heat map (n=58)
```{r}
bphi.1889_1999_heatmap <- ggmap(get_googlemap(center = c(lon = -79.74658480805773, lat = 37.20888926712938),
                                  zoom = 4,scale = 2,
                                  maptype = 'terrain',
                                  color = 'color'))+
  stat_density2d(aes(x = Longitude, y = Lat.Long, fill = ..level..),
                 alpha = .2,
                 bins = 15, data = bphi.1889_1999, geom = "polygon") +
  labs(fill="B. philenor Population Density, 1889 - 1999") +
  scale_fill_viridis_c(option = "plasma")

bphi.1889_1999_heatmap
```

2000 - 2021 Battus data heat map (n=122)
```{r}
bphi.2000_2010_heatmap <- ggmap(get_googlemap(center = c(lon = -79.74658480805773, lat = 37.20888926712938),
                                  zoom = 4,scale = 2,
                                  maptype = 'terrain',
                                  color = 'color'))+
  stat_density2d(aes(x = Longitude, y = Lat.Long, fill = ..level..),
                 alpha = .2,
                 bins = 15, data = bphi.2000_2010, geom = "polygon") +
  labs(fill="B. philenor Population Density, 2000 - 2010") +
  scale_fill_viridis_c(option = "plasma")

bphi.2000_2010_heatmap
```

2011 - 2021 Battus data heat map (n=1102). It appears that the range has shifted northward... However, it's important to note that this subset has significantly more data points than the 2000-2010 subset, and this likely impacts the resolution.
```{r}
bphi.2011_2021_heatmap <- ggmap(get_googlemap(center = c(lon = -79.74658480805773, lat = 37.20888926712938),
                                  zoom = 4,scale = 2,
                                  maptype = 'terrain',
                                  color = 'color'))+
  stat_density2d(aes(x = Longitude, y = Lat.Long, fill = ..level..),
                 alpha = .2,
                 bins = 15, data = bphi.2011_2021, geom = "polygon") +
  labs(fill="B. philenor Population Density, 2011 - 2021") +
  scale_fill_viridis_c(option = "plasma")

bphi.2011_2021_heatmap
```


Function for generating raster heat maps
```{r}
butterfly_heatmap <- function(data, num_cells, extent){
  interp <- kde2d(data$Longitude, data$Lat.Long, n=num_cells, lims=extent)
  rast <- raster(interp)
  rast[rast < 0.001] <- NA # This removes "noisy" low values in our rasters. We will need to determine the lower threshold optimal for our stats analysis, but for now it is set to 0.001. However, lowering this value increases our Pearson correlation coefficient.
  return(rast)
  
} 

conus_extent <- c(-125,-66, 25, 48) # coordinate boundaries for continental US (48 states), as a vector. I did not include all of North America, Alaska, and Hawaii.

x <- 100 # number of raster tiles/pixels per raster. We will need to determine the optimal number of pixels to use here.
```

Making a heatmap for Battus, based on year groupings
```{r}
bphi.1889_1969_heat <- butterfly_heatmap(bphi.1889_1969, n=x, conus_extent)


plot(bphi.1889_1969_heat)
```
